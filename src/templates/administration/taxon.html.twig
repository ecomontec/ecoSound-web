{% extends 'administration/admin.html.twig' %}

{% block admin_content %}
    <div class="card mb-3" id="taxonList">
        <div class="card-header border-light bg-white text-right">
            <div class="form-inline mb-3">
                <div class="col-8 form-inline">
                    <label for="phylumFilter">Phylum:</label>
                    <select id="phylumFilter" class="form-control form-control-sm selectpicker ml-3" data-live-search="true">
                        <option value=""></option>
                        {% for phylum in phyla %}
                            <option value="{{ phylum.phylum }}">{{ phylum.phylum }}</option>
                        {% endfor %}
                    </select>
                    <label for="classisFilter" class="ml-3">Classis:</label>
                    <select id="classisFilter" class="form-control form-control-sm selectpicker ml-3" data-live-search="true">
                        <option value=""></option>
                        {% for class in classes %}
                            <option value="{{ class.classis }}">{{ class.classis }}</option>
                        {% endfor %}
                    </select>
                    <label for="ordoFilter" class="ml-3">Ordo:</label>
                    <select id="ordoFilter" class="form-control form-control-sm selectpicker ml-3" data-live-search="true">
                        <option value=""></option>
                        {% for order in orders %}
                            <option value="{{ order.ordo }}">{{ order.ordo }}</option>
                        {% endfor %}
                    </select>
                    <label for="familiaFilter" class="ml-3">Familia:</label>
                    <select id="familiaFilter" class="form-control form-control-sm selectpicker ml-3" data-live-search="true">
                        <option value=""></option>
                        {% for family in families %}
                            <option value="{{ family.familia }}">{{ family.familia }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-4 form-inline justify-content-end">
                    <label class="mr-2">Search:</label>
                    <input class="form-control-sm" id="search">
                </div>
            </div>
            {% if is_admin %}
                <button id="addButton" class="btn btn-outline-primary btn-sm mt-2" type="button">
                    <i class="fas fa-plus"></i>
                    Add
                </button>
                <button id="saveButton" class="btn btn-outline-primary btn-sm mt-2" type="button" disabled>
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
                <button id="deleteButton" class="btn btn-outline-danger btn-sm mt-2" type="button" disabled>
                    <i class="fas fa-trash"></i>
                    Delete
                </button>
            {% endif %}
            <button id="taxonExport" class="btn btn-outline-primary btn-sm mt-2" type="button">
                <i class="fa fa-file-csv"></i>
                Export CSV
            </button>
        </div>
        <table id="taxonTable" style="display:none;white-space: nowrap;">
            <thead class="table-borderless">
            <tr style="font-size: .875rem;">
                <th style="{% if not is_admin %}display:none;{% endif %}">
                    {% if is_admin %}
                        <input type="checkbox" class="js-all-checkbox" name="check-all" id="check-all">
                    {% endif %}
                </th>
                <th>#</th>
                <th>Phylum</th>
                <th>Classis</th>
                <th>Ordo</th>
                <th>Familia</th>
                <th>Genus</th>
                <th>Binomial Name</th>
                <th>Common Name</th>
                <th>Source</th>
                <th>Tags</th>
            </tr>
            </thead>
            <tbody class="form-control-sm js-taxon-list"></tbody>
        </table>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="modal-delete" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">Warning</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body ml-3">
                    <div>
                        <div class="form-group">
                            <label id="delete_info">Are you sure you want to delete the selected taxa?</label>
                            <p class="text-danger"><small>Note: Taxa with associated tags cannot be deleted.</small></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="js-close-button" type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    <button id="js-delete-button" type="button" class="btn btn-outline-danger">
                        <i class="fas fa-trash-alt"></i>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Taxon Modal -->
    <div class="modal fade" id="modal-add" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Taxon</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addTaxonForm">
                        <div class="form-group">
                            <label for="new_phylum">Phylum <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="new_phylum" name="phylum" required>
                        </div>
                        <div class="form-group">
                            <label for="new_classis">Classis <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="new_classis" name="classis" required>
                        </div>
                        <div class="form-group">
                            <label for="new_ordo">Ordo</label>
                            <input type="text" class="form-control form-control-sm" id="new_ordo" name="ordo">
                        </div>
                        <div class="form-group">
                            <label for="new_familia">Familia</label>
                            <input type="text" class="form-control form-control-sm" id="new_familia" name="familia">
                        </div>
                        <div class="form-group">
                            <label for="new_genus">Genus</label>
                            <input type="text" class="form-control form-control-sm" id="new_genus" name="genus">
                        </div>
                        <div class="form-group">
                            <label for="new_binomial">Binomial Name</label>
                            <input type="text" class="form-control form-control-sm" id="new_binomial" name="binomial">
                        </div>
                        <div class="form-group">
                            <label for="new_common_name">Common Name</label>
                            <input type="text" class="form-control form-control-sm" id="new_common_name" name="common_name">
                        </div>
                        <div class="form-group">
                            <label for="new_source">Source</label>
                            <input type="text" class="form-control form-control-sm" id="new_source" name="source">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    <button id="js-add-button" type="button" class="btn btn-outline-primary">
                        <i class="fas fa-save"></i>
                        Add Taxon
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ parent() }}
    <script>
        $(document).ready(function () {
            let changedRows = new Set();
            
            $('#taxonTable').show();
            
            {% if is_admin %}
            let columnDefs = [
                {
                    "orderable": false,
                    "targets": [0]
                },
                {
                    "className": "dt-center",
                    "targets": [0, 10],
                }
            ];
            {% else %}
            let columnDefs = [
                {
                    "orderable": false,
                    "targets": [0],
                    "visible": false
                },
                {
                    "className": "dt-center",
                    "targets": [10],
                }
            ];
            {% endif %}
            
            let table = $('#taxonTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": '{{ baseUrl }}/admin/taxonMgr/getListByPage',
                    "type": 'POST',
                    "data": function(d) {
                        d.phylumFilter = $('#phylumFilter').val();
                        d.classisFilter = $('#classisFilter').val();
                        d.ordoFilter = $('#ordoFilter').val();
                        d.familiaFilter = $('#familiaFilter').val();
                    },
                    "error": function (xhr, error, thrown) {
                        if (xhr.status == 400 || xhr.status == 404 || xhr.status == 500) {
                            location.reload();
                        }
                    }
                },
                "dom": 'lrtip',
                "stateSave": true,
                "StateDuration": -1,
                "order": [[1, 'asc']],
                "columnDefs": columnDefs,
                "bAutoWidth": false,
                "scrollX": true,
            });

            if (table.state.loaded()) {
                $('#search').val(table.state.loaded().search.search);
            }

            $('#search').on('input', () => {
                table.search($('#search').val()).draw();
            });

            // Filter handlers
            $('#phylumFilter, #classisFilter, #ordoFilter, #familiaFilter').on('change', function() {
                $('.selectpicker').selectpicker('refresh');
                table.ajax.reload();
            });

            {% if is_admin %}
            // Track changes in editable fields
            $(document).on('change', '#taxonTable input[type="text"]', function() {
                let taxonId = $(this).data('id');
                changedRows.add(taxonId);
                $('#saveButton').prop('disabled', false);
            });

            // Checkbox selection
            $('.js-all-checkbox').click(function () {
                if ($(this).is(':checked')) {
                    $('.js-checkbox').prop('checked', true);
                } else {
                    $('.js-checkbox').prop('checked', false);
                }
                updateButtonStates();
            });

            $(document).on('change', '.js-checkbox', function () {
                updateButtonStates();
            });

            function updateButtonStates() {
                let checkedCount = $('.js-checkbox:checked').length;
                $('#deleteButton').prop('disabled', checkedCount === 0);
            }
            {% endif %}

            // Autocomplete functionality with hierarchical filtering
            let existingPhyla = [];
            let existingClasses = [];
            let existingOrders = [];
            let existingFamilies = [];
            let existingGenera = [];
            let existingBinomials = [];
            let taxonomyData = {};
            
            // Load all taxonomy data when modal opens
            $('#addButton').on('click', function() {
                $('#addTaxonForm')[0].reset();
                // Destroy any existing autocomplete instances (check if they exist first)
                $('#new_phylum, #new_classis, #new_ordo, #new_familia, #new_genus, #new_binomial').each(function() {
                    if ($(this).hasClass('ui-autocomplete-input')) {
                        $(this).autocomplete('destroy');
                    }
                });
                $('#modal-add').modal('show');
                
                $.ajax({
                    url: '{{ baseUrl }}/api/admin/taxonMgr/getTaxonomyHierarchy',
                    success: function(data) {
                        taxonomyData = data;
                        
                        // Extract unique values from hierarchy
                        existingPhyla = Object.keys(data);
                        existingClasses = [];
                        existingOrders = [];
                        existingFamilies = [];
                        
                        Object.keys(data).forEach(function(phylum) {
                            Object.keys(data[phylum]).forEach(function(classis) {
                                if (existingClasses.indexOf(classis) === -1) {
                                    existingClasses.push(classis);
                                }
                                Object.keys(data[phylum][classis]).forEach(function(ordo) {
                                    if (existingOrders.indexOf(ordo) === -1) {
                                        existingOrders.push(ordo);
                                    }
                                    data[phylum][classis][ordo].forEach(function(familia) {
                                        if (existingFamilies.indexOf(familia) === -1) {
                                            existingFamilies.push(familia);
                                        }
                                    });
                                });
                            });
                        });
                        
                        // Setup autocomplete for phylum
                        setupAutocomplete('#new_phylum', existingPhyla);
                        
                        // Setup autocomplete with hierarchical filtering
                        setupHierarchicalAutocomplete();
                    },
                    error: function() {
                        showAlert('Error loading taxonomy data');
                    }
                });
                
                // Load genus and binomial values
                $.ajax({
                    url: '{{ baseUrl }}/api/admin/taxonMgr/getDistinctValues',
                    success: function(data) {
                        existingGenera = data.genus || [];
                        existingBinomials = data.binomial || [];
                        setupAutocomplete('#new_genus', existingGenera);
                        setupAutocomplete('#new_binomial', existingBinomials);
                    }
                });
            });
            
            // Setup hierarchical autocomplete that filters based on parent selections
            function setupHierarchicalAutocomplete() {
                // Classis autocomplete - filtered by phylum
                $('#new_classis').autocomplete({
                    source: function(request, response) {
                        let phylum = $('#new_phylum').val();
                        let available = [];
                        
                        if (phylum && taxonomyData[phylum]) {
                            available = Object.keys(taxonomyData[phylum]);
                        } else {
                            available = existingClasses;
                        }
                        
                        let matches = $.ui.autocomplete.filter(available, request.term);
                        response(matches);
                    },
                    minLength: 0
                }).focus(function() {
                    $(this).autocomplete('search', $(this).val());
                });
                
                // Ordo autocomplete - filtered by phylum and classis
                $('#new_ordo').autocomplete({
                    source: function(request, response) {
                        let phylum = $('#new_phylum').val();
                        let classis = $('#new_classis').val();
                        let available = [];
                        
                        if (phylum && classis && taxonomyData[phylum] && taxonomyData[phylum][classis]) {
                            available = Object.keys(taxonomyData[phylum][classis]);
                        } else {
                            available = existingOrders;
                        }
                        
                        let matches = $.ui.autocomplete.filter(available, request.term);
                        response(matches);
                    },
                    minLength: 0
                }).focus(function() {
                    $(this).autocomplete('search', $(this).val());
                });
                
                // Familia autocomplete - filtered by phylum, classis, and ordo
                $('#new_familia').autocomplete({
                    source: function(request, response) {
                        let phylum = $('#new_phylum').val();
                        let classis = $('#new_classis').val();
                        let ordo = $('#new_ordo').val();
                        let available = [];
                        
                        if (phylum && classis && ordo && taxonomyData[phylum] && taxonomyData[phylum][classis] && taxonomyData[phylum][classis][ordo]) {
                            available = taxonomyData[phylum][classis][ordo];
                        } else {
                            available = existingFamilies;
                        }
                        
                        let matches = $.ui.autocomplete.filter(available, request.term);
                        response(matches);
                    },
                    minLength: 0
                }).focus(function() {
                    $(this).autocomplete('search', $(this).val());
                });
                
                // Update autocomplete when parent fields change
                $('#new_phylum').on('change', function() {
                    $('#new_classis').autocomplete('search', $('#new_classis').val());
                });
                
                $('#new_classis').on('change', function() {
                    $('#new_ordo').autocomplete('search', $('#new_ordo').val());
                });
                
                $('#new_ordo').on('change', function() {
                    $('#new_familia').autocomplete('search', $('#new_familia').val());
                });
            }
            
            // Setup autocomplete helper function
            function setupAutocomplete(selector, source) {
                $(selector).autocomplete({
                    source: source,
                    minLength: 0
                }).focus(function() {
                    $(this).autocomplete('search', $(this).val());
                });
            }

            {% if is_admin %}
            // Save changes
            $('#saveButton').click(function (e) {
                e.preventDefault();
                
                let updates = [];
                changedRows.forEach(taxonId => {
                    let row = $('input[data-id="' + taxonId + '"]').first().closest('tr');
                    let data = {
                        taxon_id: taxonId,
                        binomial: row.find('input[name="binomial"]').val(),
                        common_name: row.find('input[name="common_name"]').val(),
                        genus: row.find('input[name="genus"]').val(),
                        familia: row.find('input[name="familia"]').val(),
                        ordo: row.find('input[name="ordo"]').val(),
                        classis: row.find('input[name="classis"]').val(),
                        phylum: row.find('input[name="phylum"]').val(),
                        source: row.find('input[name="source"]').val(),
                    };
                    updates.push(data);
                });

                if (updates.length === 0) {
                    return;
                }

                // Save each update
                let promises = updates.map(data => {
                    return $.post('{{ baseUrl }}/api/admin/taxonMgr/save', data);
                });

                Promise.all(promises).then(() => {
                    showAlert('Taxa updated successfully.');
                    changedRows.clear();
                    $('#saveButton').prop('disabled', true);
                    table.ajax.reload(null, false);
                }).catch((error) => {
                    showAlert('Error updating taxa: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                });
            });

            // Add new taxon - note: click handler is already defined above for loading taxonomy data

            $('#js-add-button').click(function (e) {
                e.preventDefault();
                
                // Validate required fields
                let phylum = $('#new_phylum').val();
                let classis = $('#new_classis').val();
                
                if (!phylum || !classis) {
                    showAlert('Phylum and Classis are required fields.');
                    return;
                }
                
                // Check for new values and prepare confirmation message
                let newValues = [];
                
                if (phylum && existingPhyla.indexOf(phylum) === -1) {
                    newValues.push('Phylum: ' + phylum);
                }
                if (classis && existingClasses.indexOf(classis) === -1) {
                    newValues.push('Classis: ' + classis);
                }
                
                let ordo = $('#new_ordo').val();
                if (ordo && existingOrders.indexOf(ordo) === -1) {
                    newValues.push('Ordo: ' + ordo);
                }
                
                let familia = $('#new_familia').val();
                if (familia && existingFamilies.indexOf(familia) === -1) {
                    newValues.push('Familia: ' + familia);
                }
                
                let genus = $('#new_genus').val();
                if (genus && existingGenera.indexOf(genus) === -1) {
                    newValues.push('Genus: ' + genus);
                }
                
                let binomial = $('#new_binomial').val();
                if (binomial && existingBinomials.indexOf(binomial) === -1) {
                    newValues.push('Binomial: ' + binomial);
                }
                
                // If there are new values, show confirmation
                if (newValues.length > 0) {
                    let confirmMsg = 'You are adding new values to the database:\n\n' + newValues.join('\n') + '\n\nDo you want to continue?';
                    if (!confirm(confirmMsg)) {
                        return;
                    }
                }
                
                let data = {
                    phylum: phylum,
                    classis: classis,
                    ordo: ordo || '',
                    familia: familia || '',
                    genus: genus || '',
                    binomial: binomial || '',
                    common_name: $('#new_common_name').val() || '',
                    source: $('#new_source').val() || ''
                };
                
                $.post('{{ baseUrl }}/api/admin/taxonMgr/save', data)
                    .done(function(response) {
                        $('#modal-add').modal('hide');
                        $('#addTaxonForm')[0].reset();
                        // Destroy autocomplete to clear any lingering text
                        $('#new_phylum, #new_classis, #new_ordo, #new_familia, #new_genus, #new_binomial').each(function() {
                            if ($(this).hasClass('ui-autocomplete-input')) {
                                $(this).autocomplete('destroy');
                            }
                        });
                        showAlert('Taxon added successfully.');
                        table.ajax.reload(null, false); // false = stay on current page
                    })
                    .fail(function(xhr) {
                        let errorMsg = 'Error adding taxon';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ': ' + xhr.responseJSON.message;
                        }
                        showAlert(errorMsg);
                    });
            });

            // Delete taxa
            $('#deleteButton').click(function (e) {
                e.preventDefault();
                let selectedCount = $('.js-checkbox:checked').length;
                if (selectedCount > 0) {
                    $('#delete_info').html('Are you sure you want to delete <b class="text-danger">' + selectedCount + '</b> taxa?');
                    $('#modal-delete').modal('show');
                }
            });

            $('#js-delete-button').click(function (e) {
                e.preventDefault();
                
                let id = [];
                $('.js-checkbox:checked').each(function () {
                    id.push($(this).data('id'));
                });
                
                let data = {'id': id};
                
                $.post('{{ baseUrl }}/api/admin/taxonMgr/delete', data)
                    .done(function(response) {
                        $('#modal-delete').modal('hide');
                        showAlert('Taxa deleted successfully.');
                        table.ajax.reload();
                    })
                    .fail(function(xhr) {
                        $('#modal-delete').modal('hide');
                        let errorMsg = 'Error deleting taxa';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ': ' + xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            errorMsg += ': ' + xhr.responseText;
                        }
                        showAlert(errorMsg);
                    });
            });
            {% endif %}

            // Export CSV
            $('#taxonExport').click(function () {
                window.location.href = '{{ baseUrl }}/api/admin/taxonMgr/export';
            });

            // Clean up autocomplete when modal is closed
            $('#modal-add').on('hidden.bs.modal', function () {
                $('#addTaxonForm')[0].reset();
                $('#new_phylum, #new_classis, #new_ordo, #new_familia, #new_genus, #new_binomial').each(function() {
                    if ($(this).hasClass('ui-autocomplete-input')) {
                        $(this).autocomplete('destroy');
                    }
                });
            });

            // Initialize select pickers
            $('.selectpicker').selectpicker();
        });
    </script>
{% endblock %}
