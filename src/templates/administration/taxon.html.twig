{% extends 'administration/admin.html.twig' %}

{% block admin_content %}
    <div class="card mb-3" id="taxonList">
        <div class="card-header border-light bg-white text-right">
            <div class="form-inline mb-3">
                <div class="col-8 form-inline">
                    <label for="classisFilter">Classis:</label>
                    <select id="classisFilter" class="form-control form-control-sm selectpicker ml-3" data-live-search="true">
                        <option value="">All</option>
                        {% for class in classes %}
                            <option value="{{ class.classis }}">{{ class.classis }}</option>
                        {% endfor %}
                    </select>
                    <label for="ordoFilter" class="ml-3">Ordo:</label>
                    <select id="ordoFilter" class="form-control form-control-sm selectpicker ml-3" data-live-search="true">
                        <option value="">All</option>
                        {% for order in orders %}
                            <option value="{{ order.ordo }}">{{ order.ordo }}</option>
                        {% endfor %}
                    </select>
                    <label for="familiaFilter" class="ml-3">Familia:</label>
                    <select id="familiaFilter" class="form-control form-control-sm selectpicker ml-3" data-live-search="true">
                        <option value="">All</option>
                        {% for family in families %}
                            <option value="{{ family.familia }}">{{ family.familia }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-4 form-inline justify-content-end">
                    <label class="mr-2">Search:</label>
                    <input class="form-control-sm" id="search">
                </div>
            </div>
            {% if is_admin %}
                <button id="addButton" class="btn btn-outline-primary btn-sm mt-2" type="button">
                    <i class="fas fa-plus"></i>
                    Add
                </button>
                <button id="saveButton" class="btn btn-outline-primary btn-sm mt-2" type="button" disabled>
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
                <button id="deleteButton" class="btn btn-outline-primary btn-sm mt-2" type="button" disabled>
                    <i class="fas fa-trash"></i>
                    Delete
                </button>
            {% endif %}
            <button id="taxonExport" class="btn btn-outline-primary btn-sm mt-2" type="button">
                <i class="fa fa-file-csv"></i>
                Export CSV
            </button>
        </div>
        <table id="taxonTable" style="display:none;white-space: nowrap;">
            <thead class="table-borderless">
            <tr style="font-size: .875rem;">
                <th style="{% if not is_admin %}display:none;{% endif %}">
                    {% if is_admin %}
                        <input type="checkbox" class="js-all-checkbox" name="check-all" id="check-all">
                    {% endif %}
                </th>
                <th>#</th>
                <th>Binomial Name</th>
                <th>Common Name</th>
                <th>Genus</th>
                <th>Familia</th>
                <th>Ordo</th>
                <th>Classis</th>
                <th>Phylum</th>
                <th>Source</th>
                <th>Tags</th>
                <th>Recordings</th>
            </tr>
            </thead>
            <tbody class="form-control-sm js-taxon-list"></tbody>
        </table>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="modal-delete" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">Warning</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body ml-3">
                    <div>
                        <div class="form-group">
                            <label id="delete_info">Are you sure you want to delete the selected taxa?</label>
                            <p class="text-danger"><small>Note: Taxa with associated tags cannot be deleted.</small></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="js-close-button" type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    <button id="js-delete-button" type="button" class="btn btn-outline-danger">
                        <i class="fas fa-trash-alt"></i>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Taxon Modal -->
    <div class="modal fade" id="modal-add" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Taxon</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addTaxonForm">
                        <div class="form-group">
                            <label for="new_binomial">Binomial Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm autocomplete-field" id="new_binomial" name="binomial" data-field="binomial" required>
                        </div>
                        <div class="form-group">
                            <label for="new_common_name">Common Name</label>
                            <input type="text" class="form-control form-control-sm" id="new_common_name" name="common_name">
                        </div>
                        <div class="form-group">
                            <label for="new_genus">Genus</label>
                            <input type="text" class="form-control form-control-sm autocomplete-field" id="new_genus" name="genus" data-field="genus">
                        </div>
                        <div class="form-group">
                            <label for="new_familia">Familia</label>
                            <input type="text" class="form-control form-control-sm autocomplete-field" id="new_familia" name="familia" data-field="familia">
                        </div>
                        <div class="form-group">
                            <label for="new_ordo">Ordo</label>
                            <input type="text" class="form-control form-control-sm autocomplete-field" id="new_ordo" name="ordo" data-field="ordo">
                        </div>
                        <div class="form-group">
                            <label for="new_classis">Classis <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm autocomplete-field" id="new_classis" name="classis" data-field="classis" required>
                        </div>
                        <div class="form-group">
                            <label for="new_phylum">Phylum</label>
                            <input type="text" class="form-control form-control-sm autocomplete-field" id="new_phylum" name="phylum" data-field="phylum">
                        </div>
                        <div class="form-group">
                            <label for="new_source">Source</label>
                            <input type="text" class="form-control form-control-sm autocomplete-field" id="new_source" name="source" data-field="source">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    <button id="js-add-button" type="button" class="btn btn-outline-primary">
                        <i class="fas fa-save"></i>
                        Add Taxon
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ parent() }}
    <script>
        $(document).ready(function () {
            let changedRows = new Set();
            
            $('#taxonTable').show();
            
            {% if is_admin %}
            let columnDefs = [
                {
                    "orderable": false,
                    "targets": [0]
                },
                {
                    "className": "dt-center",
                    "targets": [0, 10, 11],
                }
            ];
            {% else %}
            let columnDefs = [
                {
                    "orderable": false,
                    "targets": [0],
                    "visible": false
                },
                {
                    "className": "dt-center",
                    "targets": [10, 11],
                }
            ];
            {% endif %}
            
            let table = $('#taxonTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": '{{ baseUrl }}/admin/taxonMgr/getListByPage',
                    "type": 'POST',
                    "data": function(d) {
                        d.classisFilter = $('#classisFilter').val();
                        d.ordoFilter = $('#ordoFilter').val();
                        d.familiaFilter = $('#familiaFilter').val();
                    },
                    "error": function (xhr, error, thrown) {
                        if (xhr.status == 400 || xhr.status == 404 || xhr.status == 500) {
                            location.reload();
                        }
                    }
                },
                "dom": 'lrtip',
                "stateSave": true,
                "StateDuration": -1,
                "order": [[1, 'asc']],
                "columnDefs": columnDefs,
                "bAutoWidth": false,
                "scrollX": true,
            });

            if (table.state.loaded()) {
                $('#search').val(table.state.loaded().search.search);
            }

            $('#search').on('input', () => {
                table.search($('#search').val()).draw();
            });

            // Filter handlers
            $('#classisFilter, #ordoFilter, #familiaFilter').on('change', function() {
                $('.selectpicker').selectpicker('refresh');
                table.ajax.reload();
            });

            {% if is_admin %}
            // Track changes in editable fields
            $(document).on('change', '#taxonTable input[type="text"]', function() {
                let taxonId = $(this).data('id');
                changedRows.add(taxonId);
                $('#saveButton').prop('disabled', false);
            });

            // Checkbox selection
            $('.js-all-checkbox').click(function () {
                if ($(this).is(':checked')) {
                    $('.js-checkbox').prop('checked', true);
                } else {
                    $('.js-checkbox').prop('checked', false);
                }
                updateButtonStates();
            });

            $(document).on('change', '.js-checkbox', function () {
                updateButtonStates();
            });

            function updateButtonStates() {
                let checkedCount = $('.js-checkbox:checked').length;
                $('#deleteButton').prop('disabled', checkedCount === 0);
            }
            {% endif %}

            // Autocomplete functionality
            function setupAutocomplete(selector) {
                $(document).on('focus', selector, function() {
                    let $this = $(this);
                    if ($this.data('autocomplete-initialized')) {
                        return;
                    }
                    
                    $this.data('autocomplete-initialized', true);
                    
                    let field = $this.data('field');
                    
                    $this.autocomplete({
                        source: function(request, response) {
                            $.ajax({
                                url: '{{ baseUrl }}/api/admin/taxonMgr/autocomplete',
                                data: {
                                    field: field,
                                    term: request.term
                                },
                                success: function(data) {
                                    response(data);
                                }
                            });
                        },
                        minLength: 1,
                        select: function(event, ui) {
                            // Auto-fill higher taxonomic ranks
                            $.ajax({
                                url: '{{ baseUrl }}/api/admin/taxonMgr/getHigherRanks',
                                data: {
                                    field: field,
                                    value: ui.item.value
                                },
                                success: function(ranks) {
                                    if (ranks && Object.keys(ranks).length > 0) {
                                        let formId = $this.closest('form').attr('id');
                                        if (formId === 'addTaxonForm') {
                                            if (ranks.genus && !$('#new_genus').val()) {
                                                $('#new_genus').val(ranks.genus);
                                            }
                                            if (ranks.familia && !$('#new_familia').val()) {
                                                $('#new_familia').val(ranks.familia);
                                            }
                                            if (ranks.ordo && !$('#new_ordo').val()) {
                                                $('#new_ordo').val(ranks.ordo);
                                            }
                                            if (ranks.classis && !$('#new_classis').val()) {
                                                $('#new_classis').val(ranks.classis);
                                            }
                                            if (ranks.phylum && !$('#new_phylum').val()) {
                                                $('#new_phylum').val(ranks.phylum);
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                });
            }

            setupAutocomplete('.autocomplete-field');

            {% if is_admin %}
            // Save changes
            $('#saveButton').click(function (e) {
                e.preventDefault();
                
                let updates = [];
                changedRows.forEach(taxonId => {
                    let row = $('input[data-id="' + taxonId + '"]').first().closest('tr');
                    let data = {
                        taxon_id: taxonId,
                        binomial: row.find('input[name="binomial"]').val(),
                        common_name: row.find('input[name="common_name"]').val(),
                        genus: row.find('input[name="genus"]').val(),
                        familia: row.find('input[name="familia"]').val(),
                        ordo: row.find('input[name="ordo"]').val(),
                        classis: row.find('input[name="classis"]').val(),
                        phylum: row.find('input[name="phylum"]').val(),
                        source: row.find('input[name="source"]').val(),
                    };
                    updates.push(data);
                });

                if (updates.length === 0) {
                    return;
                }

                // Save each update
                let promises = updates.map(data => {
                    return $.post('{{ baseUrl }}/api/admin/taxonMgr/save', data);
                });

                Promise.all(promises).then(() => {
                    showAlert('Taxa updated successfully.');
                    changedRows.clear();
                    $('#saveButton').prop('disabled', true);
                    table.ajax.reload(null, false);
                }).catch((error) => {
                    showAlert('Error updating taxa: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                });
            });

            // Add new taxon
            $('#addButton').click(function (e) {
                e.preventDefault();
                $('#addTaxonForm')[0].reset();
                $('#modal-add').modal('show');
            });

            $('#js-add-button').click(function (e) {
                e.preventDefault();
                
                let formData = new FormData($('#addTaxonForm')[0]);
                
                postRequest('{{ baseUrl }}/api/admin/taxonMgr/save', formData, false, false, function (response) {
                    $('#modal-add').modal('hide');
                    showAlert('Taxon added successfully.');
                    table.ajax.reload();
                });
            });

            // Delete taxa
            $('#deleteButton').click(function (e) {
                e.preventDefault();
                let selectedCount = $('.js-checkbox:checked').length;
                if (selectedCount > 0) {
                    $('#delete_info').html('Are you sure you want to delete <b class="text-danger">' + selectedCount + '</b> taxa?');
                    $('#modal-delete').modal('show');
                }
            });

            $('#js-delete-button').click(function (e) {
                e.preventDefault();
                
                let id = [];
                $('.js-checkbox:checked').each(function () {
                    id.push($(this).data('id'));
                });
                
                let data = {'id': id};
                postRequest('{{ baseUrl }}/api/admin/taxonMgr/delete', data, false, false, function () {
                    $('#modal-delete').modal('hide');
                    showAlert('Taxa deleted successfully.');
                    table.ajax.reload();
                });
            });
            {% endif %}

            // Export CSV
            $('#taxonExport').click(function () {
                window.location.href = '{{ baseUrl }}/api/admin/taxonMgr/export';
            });

            // Initialize select pickers
            $('.selectpicker').selectpicker();
        });
    </script>
{% endblock %}
